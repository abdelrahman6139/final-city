generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Branch {
  id             Int             @id @default(autoincrement())
  name           String          @db.VarChar(255)
  code           String          @unique @db.VarChar(50)
  address        String?
  active         Boolean         @default(true)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  goodsReceipts  GoodsReceipt[]
  purchaseOrders PurchaseOrder[]
  salesInvoices  SalesInvoice[]
  salesReturns   SalesReturn[]
  stockLocations StockLocation[]
  users          User[]

  @@map("branches")
}

model User {
  id             Int             @id @default(autoincrement())
  username       String          @unique @db.VarChar(100)
  passwordHash   String          @map("password_hash") @db.VarChar(255)
  fullName       String          @map("full_name") @db.VarChar(255)
  branchId       Int             @map("branch_id")
  active         Boolean         @default(true)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  goodsReceipts  GoodsReceipt[]
  payments       Payment[]
  priceHistory   PriceHistory[]
  productAudits  ProductAudit[]
  salesInvoices  SalesInvoice[]
  salesReturns   SalesReturn[]
  stockMovements StockMovement[]
  roles          UserRole[]
  branch         Branch          @relation(fields: [branchId], references: [id])

  @@map("users")
}

model Payment {
  id             Int           @id @default(autoincrement())
  salesInvoiceId Int           @map("sales_invoice_id")
  amount         Decimal       @db.Decimal(10, 2)
  paymentMethod  PaymentMethod @map("payment_method")
  paymentDate    DateTime      @default(now()) @map("payment_date")
  notes          String?
  createdBy      Int           @map("created_by")
  createdAt      DateTime      @default(now()) @map("created_at")
  user           User          @relation(fields: [createdBy], references: [id])
  salesInvoice   SalesInvoice  @relation(fields: [salesInvoiceId], references: [id], onDelete: Cascade)

  @@index([salesInvoiceId])
  @@index([paymentDate])
  @@map("payments")
}

model Role {
  id          Int              @id @default(autoincrement())
  name        String           @unique @db.VarChar(100)
  description String?
  isSystem    Boolean  @default(false) @map("is_system") 
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  permissions RolePermission[]
  pages       RolePage[]
  users       UserRole[]

  @@map("roles")
}

model Permission {
  id          Int              @id @default(autoincrement())
  name        String           @unique @db.VarChar(100)
  description String?
  createdAt   DateTime         @default(now()) @map("created_at")
  roles       RolePermission[]

  @@map("permissions")
}

model Page {
  id          Int        @id @default(autoincrement())
  key         String     @unique @db.VarChar(50)  // "sales", "products", "customers"
  nameEn      String     @map("name_en") @db.VarChar(100)
  nameAr      String     @map("name_ar") @db.VarChar(100)
  category    String     @db.VarChar(50)  // "transactions", "inventory", "admin", "people"
  icon        String?    @db.VarChar(50)
  route       String?    @db.VarChar(100)  // "/sales", "/products"
  sortOrder   Int        @default(0) @map("sort_order")
  active      Boolean    @default(true)
  createdAt   DateTime   @default(now()) @map("created_at")
  roles       RolePage[]

  @@map("pages")
}

model RolePage {
  roleId Int  @map("role_id")
  pageId Int  @map("page_id")
  page   Page @relation(fields: [pageId], references: [id], onDelete: Cascade)
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, pageId])
  @@map("role_pages")
}

model UserRole {
  userId Int  @map("user_id")
  roleId Int  @map("role_id")
  role   Role @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

model RolePermission {
  roleId       Int        @map("role_id")
  permissionId Int        @map("permission_id")
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model Customer {
  id            Int            @id @default(autoincrement())
  name          String         @db.VarChar(255)
  phone         String?        @unique @db.VarChar(50)
  type          CustomerType   @default(RETAIL)
  taxNumber     String?        @map("tax_number") @db.VarChar(50)
  address       String?
  active        Boolean        @default(true)
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  salesInvoices SalesInvoice[]

  @@map("customers")
}

model Category {
  id            Int           @id @default(autoincrement())
  name          String        @db.VarChar(255)
  nameAr        String?       @map("name_ar") @db.VarChar(255)
  active        Boolean       @default(true)
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")
  defaultRetailMargin     Float?  @map("default_retail_margin")
  defaultWholesaleMargin  Float?  @map("default_wholesale_margin")
  products      Product[]
  subcategories Subcategory[]

  @@map("categories")
}

model Subcategory {
  id         Int        @id @default(autoincrement())
  categoryId Int        @map("category_id")
  name       String     @db.VarChar(255)
  nameAr     String?    @map("name_ar") @db.VarChar(255)
  active     Boolean    @default(true)
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")
  defaultRetailMargin     Float?  @map("default_retail_margin")
  defaultWholesaleMargin  Float?  @map("default_wholesale_margin")
  itemTypes  ItemType[]
  category   Category   @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@map("subcategories")
}

model ItemType {
  id            Int         @id @default(autoincrement())
  subcategoryId Int         @map("subcategory_id")
  name          String      @db.VarChar(255)
  nameAr        String?     @map("name_ar") @db.VarChar(255)
  active        Boolean     @default(true)
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  defaultRetailMargin     Float?  @map("default_retail_margin")
  defaultWholesaleMargin  Float?  @map("default_wholesale_margin")
  subcategory   Subcategory @relation(fields: [subcategoryId], references: [id], onDelete: Cascade)
  products      Product[]

  @@index([subcategoryId])
  @@map("item_types")
}

model Product {
  id               Int                 @id @default(autoincrement())
  code             String              @unique @db.VarChar(50)
  barcode          String?             @unique @db.VarChar(100)
  nameEn           String              @map("name_en") @db.VarChar(255)
  nameAr           String?             @map("name_ar") @db.VarChar(255)
  categoryId       Int?                @map("category_id")
  brand            String?             @db.VarChar(255)
  unit             String              @default("PCS") @db.VarChar(50)
  cost             Decimal             @default(0) @db.Decimal(10, 2)
  costAvg          Decimal             @default(0) @map("cost_avg") @db.Decimal(10, 2)
  priceRetail      Decimal             @default(0) @map("price_retail") @db.Decimal(10, 2)
  priceWholesale   Decimal             @default(0) @map("price_wholesale") @db.Decimal(10, 2)
  retailMargin         Float?          @map("retail_margin")
  wholesaleMargin      Float?          @map("wholesale_margin")
  minQty           Int?                @map("min_qty")
  maxQty           Int?                @map("max_qty")
  active           Boolean             @default(true)
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")
  itemTypeId       Int?                @map("item_type_id")
  grnLines         GoodsReceiptLine[]
  priceHistory     PriceHistory[]
  audits           ProductAudit[]
  category         Category?           @relation(fields: [categoryId], references: [id])
  itemType         ItemType?           @relation(fields: [itemTypeId], references: [id])
  poLines          PurchaseOrderLine[]
  salesLines       SalesLine[]
  salesReturnLines SalesReturnLine[]
  stockMovements   StockMovement[]

  @@index([code])
  @@index([barcode])
  @@index([itemTypeId])
  @@map("products")
}

model ProductAudit {
  id        Int         @id @default(autoincrement())
  productId Int         @map("product_id")
  action    AuditAction
  oldData   Json?       @map("old_data")
  newData   Json?       @map("new_data")
  userId    Int         @map("user_id")
  createdAt DateTime    @default(now()) @map("created_at")
  product   Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id])

  @@index([productId])
  @@map("product_audits")
}

model StockLocation {
  id             Int             @id @default(autoincrement())
  branchId       Int             @map("branch_id")
  name           String          @db.VarChar(255)
  active         Boolean         @default(true)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  branch         Branch          @relation(fields: [branchId], references: [id])
  stockMovements StockMovement[]

  @@map("stock_locations")
}

model StockMovement {
  id              Int           @id @default(autoincrement())
  productId       Int           @map("product_id")
  stockLocationId Int           @map("stock_location_id")
  qtyChange       Int           @map("qty_change")
  movementType    MovementType  @map("movement_type")
  refTable        String?       @map("ref_table") @db.VarChar(100)
  refId           Int?          @map("ref_id")
  notes           String?
  createdBy       Int           @map("created_by")
  createdAt       DateTime      @default(now()) @map("created_at")
  user            User          @relation(fields: [createdBy], references: [id])
  product         Product       @relation(fields: [productId], references: [id])
  stockLocation   StockLocation @relation(fields: [stockLocationId], references: [id])

  @@index([productId, stockLocationId])
  @@index([refTable, refId])
  @@map("stock_movements")
}

model SalesInvoice {
  id                 Int            @id @default(autoincrement())
  invoiceNo          String         @unique @map("invoiceno") @db.VarChar(50)
  branchId           Int            @map("branchid")
  customerId         Int?           @map("customerid")
  subtotal           Decimal        @default(0) @db.Decimal(10, 2)
  total              Decimal        @default(0) @db.Decimal(10, 2)
  totalTax           Decimal        @default(0) @map("totaltax") @db.Decimal(10, 2)
  totalDiscount      Decimal        @default(0) @map("totaldiscount") @db.Decimal(10, 2)
  discountAmount     Decimal        @default(0) @map("discountamount") @db.Decimal(10, 2)
  platformCommission Decimal        @default(0) @map("platformcommission") @db.Decimal(10, 2)
  channel            String?        @db.VarChar(50)
  paymentStatus      PaymentStatus  @default(PAID) @map("paymentstatus")
  paymentMethod      PaymentMethod  @map("paymentmethod")
  notes              String?
  createdBy          Int            @map("createdby")
  createdAt          DateTime       @default(now()) @map("createdat")
  updatedAt          DateTime       @updatedAt @map("updatedat")
  
  // Profit tracking
  costOfGoods        Decimal?       @map("costofgoods") @db.Decimal(10, 2)
  grossProfit        Decimal?       @map("grossprofit") @db.Decimal(10, 2)
  netProfit          Decimal?       @map("netprofit") @db.Decimal(10, 2)
  profitMargin       Decimal?       @map("profitmargin") @db.Decimal(5, 2)
  
  // ✅ NEW: Return tracking
  totalRefunded      Decimal        @default(0) @map("totalrefunded") @db.Decimal(10, 2)
  netRevenue         Decimal?       @map("netrevenue") @db.Decimal(10, 2)
  
  // Shipping & delivery
  shippingFee        Decimal        @default(0) @map("shippingfee") @db.Decimal(10, 2)
  delivered          Boolean        @default(false)
  deliveryDate       DateTime?      @map("deliverydate")
  
  // Payment tracking
  paidAmount         Decimal        @default(0) @map("paidamount") @db.Decimal(10, 2)
  remainingAmount    Decimal        @default(0) @map("remainingamount") @db.Decimal(10, 2)
  
  payments           Payment[]
  branch             Branch         @relation(fields: [branchId], references: [id])
  user               User           @relation(fields: [createdBy], references: [id])
  customer           Customer?      @relation(fields: [customerId], references: [id])
  lines              SalesLine[]
  returns            SalesReturn[]  @relation("InvoiceReturns")

  @@index([createdAt, branchId])
  @@map("salesinvoices")
}


model SalesLine {
  id             Int          @id @default(autoincrement())
  salesInvoiceId Int          @map("sales_invoice_id")
  productId      Int          @map("product_id")
  qty            Int
  unitPrice      Decimal      @map("unit_price") @db.Decimal(10, 2)
  lineDiscount   Decimal      @default(0) @map("line_discount") @db.Decimal(10, 2)
  taxRate        Decimal      @default(0) @map("tax_rate") @db.Decimal(5, 2)
  lineTotal      Decimal      @map("line_total") @db.Decimal(10, 2)
  priceType      String?       @map("pricetype") @db.VarChar(20)
  product        Product      @relation(fields: [productId], references: [id])
  salesInvoice   SalesInvoice @relation(fields: [salesInvoiceId], references: [id], onDelete: Cascade)

  @@map("sales_lines")
}

model SalesReturn {
  id              Int               @id @default(autoincrement())
  returnNo        String            @unique @map("returnno") @db.VarChar(50)
  salesInvoiceId  Int               @map("salesinvoiceid")
  branchId        Int               @map("branchid")
  totalRefund     Decimal           @default(0) @map("totalrefund") @db.Decimal(10, 2)
  reason          String?
  createdBy       Int               @map("createdby")
  createdAt       DateTime          @default(now()) @map("createdat")
  
  lines           SalesReturnLine[]
  branch          Branch            @relation(fields: [branchId], references: [id])
  user            User              @relation(fields: [createdBy], references: [id])
  salesInvoice    SalesInvoice      @relation("InvoiceReturns", fields: [salesInvoiceId], references: [id]) // ✅ ADD THIS

  @@index([createdAt, branchId])
  @@map("salesreturns")
}


model SalesReturnLine {
  id           Int         @id @default(autoincrement())
  returnId     Int         @map("return_id")
  productId    Int         @map("product_id")
  qtyReturned  Int         @map("qty_returned")
  refundAmount Decimal     @map("refund_amount") @db.Decimal(10, 2)
  returnType   ReturnType  @default(STOCK) @map("return_type")
  product      Product     @relation(fields: [productId], references: [id])
  salesReturn  SalesReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)

  @@index([returnType])
  @@map("sales_return_lines")
}

model Supplier {
  id             Int             @id @default(autoincrement())
  name           String          @db.VarChar(255)
  contact        String?         @db.VarChar(255)
  phone          String?         @db.VarChar(50)
  email          String?         @db.VarChar(255)
  address        String?
  paymentTerms   String?         @map("payment_terms")
  active         Boolean         @default(true)
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  goodsReceipts  GoodsReceipt[]
  purchaseOrders PurchaseOrder[]

  @@map("suppliers")
}

model PurchaseOrder {
  id           Int                 @id @default(autoincrement())
  poNo         String              @unique @map("po_no") @db.VarChar(50)
  supplierId   Int                 @map("supplier_id")
  branchId     Int                 @map("branch_id")
  status       POStatus            @default(DRAFT)
  expectedDate DateTime            @map("expected_date")
  notes        String?
  createdAt    DateTime            @default(now()) @map("created_at")
  updatedAt    DateTime            @updatedAt @map("updated_at")
  lines        PurchaseOrderLine[]
  branch       Branch              @relation(fields: [branchId], references: [id])
  supplier     Supplier            @relation(fields: [supplierId], references: [id])

  @@map("purchase_orders")
}

model PurchaseOrderLine {
  id              Int           @id @default(autoincrement())
  purchaseOrderId Int           @map("purchase_order_id")
  productId       Int           @map("product_id")
  qty             Int
  price           Decimal       @db.Decimal(10, 2)
  product         Product       @relation(fields: [productId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@map("purchase_order_lines")
}

model GoodsReceipt {
  id          Int                @id @default(autoincrement())
  grnNo       String             @unique @map("grn_no") @db.VarChar(50)
  supplierId  Int                @map("supplier_id")
  branchId    Int                @map("branch_id")
  relatedPoId Int?               @map("related_po_id")
  paymentTerm PaymentTerm        @default(CASH) @map("payment_term")
  subtotal    Decimal            @default(0) @db.Decimal(10, 2)
  taxRate     Decimal            @default(14) @map("tax_rate") @db.Decimal(5, 2)
  taxAmount   Decimal            @default(0) @map("tax_amount") @db.Decimal(10, 2)
  total       Decimal            @default(0) @db.Decimal(10, 2)
  notes       String?
  createdBy   Int                @map("created_by")
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")
  lines       GoodsReceiptLine[]
  branch      Branch             @relation(fields: [branchId], references: [id])
  user        User               @relation(fields: [createdBy], references: [id])
  supplier    Supplier           @relation(fields: [supplierId], references: [id])

  @@index([createdAt, branchId])
  @@map("goods_receipts")
}

model GoodsReceiptLine {
  id             Int          @id @default(autoincrement())
  goodsReceiptId Int          @map("goods_receipt_id")
  productId      Int          @map("product_id")
  qty            Int
  cost           Decimal      @db.Decimal(10, 2)
  goodsReceipt   GoodsReceipt @relation(fields: [goodsReceiptId], references: [id], onDelete: Cascade)
  product        Product      @relation(fields: [productId], references: [id])

  @@map("goods_receipt_lines")
}

model PlatformSettings {
  id          Int      @id @default(autoincrement())
  platform    String   @unique @db.VarChar(50)
  taxRate     Decimal  @default(0) @map("tax_rate") @db.Decimal(5, 2)
  commission  Decimal  @default(0) @db.Decimal(5, 2)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  icon        String?  @db.VarChar(10)
  name        String?  @db.VarChar(100)
  shippingFee Decimal  @default(0) @map("shipping_fee") @db.Decimal(10, 2)

  @@map("platform_settings")
}

model PriceHistory {
  id        Int      @id @default(autoincrement())
  productId Int      @map("product_id")
  oldPrice  Decimal  @map("old_price") @db.Decimal(10, 2)
  newPrice  Decimal  @map("new_price") @db.Decimal(10, 2)
  priceType String   @map("price_type") @db.VarChar(20)
  changedBy Int      @map("changed_by")
  reason    String?
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [changedBy], references: [id])
  product   Product  @relation(fields: [productId], references: [id])

  @@index([productId])
  @@map("price_history")
}

enum CustomerType {
  RETAIL
  WHOLESALE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

enum MovementType {
  SALE
  RETURN
  GRN
  TRANSFER_IN
  TRANSFER_OUT
  ADJUSTMENT
}

enum PaymentStatus {
  PAID
  PARTIAL
  UNPAID
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  MIXED
  INSTAPAY
  FAWRY
  WALLET
}

enum ReturnType {
  STOCK
  DEFECTIVE
}

enum POStatus {
  DRAFT
  CONFIRMED
  CLOSED
}

enum PaymentTerm {
  CASH
  DAYS_15
  DAYS_30
  DAYS_60
}
